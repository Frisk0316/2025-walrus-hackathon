components:
  schemas:
    KPIProposal:
      type: object
      description: Buyer's proposed KPI value for a period
      required:
        - kpiType
        - value
        - unit
        - proposedBy
        - proposedAt
        - status
      properties:
        kpiType:
          type: string
          description: Type of KPI being proposed
          example: "revenue"
        value:
          type: number
          description: Proposed KPI value
          example: 11300000
        unit:
          type: string
          description: Unit of measurement
          example: "USD"
        proposedBy:
          type: string
          description: Sui address of proposer (buyer)
          pattern: '^0x[a-fA-F0-9]{64}$'
          example: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
        proposedAt:
          type: string
          format: date-time
          description: Proposal timestamp
          example: "2027-01-15T10:00:00Z"
        status:
          type: string
          enum: ["pending", "approved", "rejected"]
          description: Attestation status
          example: "pending"
        calculatedPayout:
          type: number
          description: Calculated earn-out amount based on formula
          example: 2600000
        notes:
          type: string
          description: Optional notes from buyer
          example: "Calculated from audited financial statements"
        supportingBlobIds:
          type: array
          description: Walrus blob IDs containing supporting documents
          items:
            type: string
            example: "blob_xyz789"

    KPIAttestation:
      type: object
      description: Auditor's attestation of KPI value
      required:
        - kpiType
        - attestedValue
        - unit
        - attestedBy
        - attestedAt
        - approved
      properties:
        kpiType:
          type: string
          description: Type of KPI attested
          example: "revenue"
        attestedValue:
          type: number
          description: Auditor-verified KPI value
          example: 11300000
        unit:
          type: string
          description: Unit of measurement
          example: "USD"
        attestedBy:
          type: string
          description: Sui address of auditor
          pattern: '^0x[a-fA-F0-9]{64}$'
          example: "0x9876543210abcdef1234567890abcdef1234567890abcdef1234567890abcd"
        attestedAt:
          type: string
          format: date-time
          description: Attestation timestamp
          example: "2027-02-01T14:30:00Z"
        approved:
          type: boolean
          description: Whether KPI is approved
          example: true
        finalPayout:
          type: number
          description: Final calculated payout amount
          example: 2600000
        notes:
          type: string
          description: Auditor's notes
          example: "Verified against source documents. Revenue figure confirmed."
        verifiedBlobIds:
          type: array
          description: Walrus blob IDs that were verified
          items:
            type: string
            example: "blob_xyz789"
        txHash:
          type: string
          description: Sui transaction hash for attestation
          pattern: '^[A-Za-z0-9+/=]{44}$'
          example: "9wqLfZUqP9K3xYz1RnN2BcE4MpX7Ri5L"

    ProposeKPIRequest:
      type: object
      required:
        - kpiType
        - value
        - unit
      properties:
        kpiType:
          type: string
          description: Type of KPI
          example: "revenue"
        value:
          type: number
          minimum: 0
          description: Proposed KPI value
          example: 11300000
        unit:
          type: string
          description: Unit of measurement
          example: "USD"
        notes:
          type: string
          maxLength: 1000
          description: Optional notes explaining the calculation
          example: "Based on Q1-Q4 2026 revenue, audited by external accountant"
        supportingBlobIds:
          type: array
          description: Walrus blob IDs containing supporting documents
          items:
            type: string
          example: ["blob_revenue_q1", "blob_revenue_q2", "blob_revenue_q3", "blob_revenue_q4"]

    ProposeKPIResponse:
      type: object
      required:
        - proposal
        - calculatedPayout
        - transaction
      properties:
        proposal:
          $ref: '#/components/schemas/KPIProposal'
        calculatedPayout:
          type: object
          description: Payout calculation preview
          required:
            - kpiValue
            - threshold
            - maxPayout
            - calculatedAmount
          properties:
            kpiValue:
              type: number
              description: Proposed KPI value
              example: 11300000
            threshold:
              type: number
              description: Minimum threshold from parameters
              example: 10000000
            maxPayout:
              type: number
              description: Maximum possible payout
              example: 5000000
            calculatedAmount:
              type: number
              description: Calculated payout for this KPI
              example: 2600000
            formula:
              type: string
              description: Formula used for calculation
              example: "Linear: (KPI - 10M) / (15M - 10M) * 5M"
        transaction:
          type: object
          description: Unsigned transaction to propose KPI on-chain
          required:
            - txBytes
            - description
          properties:
            txBytes:
              type: string
              description: Base64 encoded transaction bytes
            description:
              type: string
              example: "Propose KPI: Revenue = $11,300,000"
            estimatedGas:
              type: integer
              example: 1500000

    AttestKPIRequest:
      type: object
      required:
        - kpiType
        - value
        - approved
      properties:
        kpiType:
          type: string
          description: Type of KPI being attested
          example: "revenue"
        value:
          type: number
          minimum: 0
          description: Auditor-verified KPI value
          example: 11300000
        approved:
          type: boolean
          description: Whether auditor approves this KPI
          example: true
        notes:
          type: string
          maxLength: 2000
          description: Auditor's notes
          example: "Verified all revenue journals and supporting documents. Calculations are accurate."
        verifiedBlobIds:
          type: array
          description: Blob IDs that were verified during audit
          items:
            type: string
          example: ["blob_revenue_q1", "blob_revenue_q2"]

    AttestKPIResponse:
      type: object
      required:
        - attestation
        - transaction
      properties:
        attestation:
          $ref: '#/components/schemas/KPIAttestation'
        transaction:
          type: object
          description: Unsigned transaction to attest KPI on-chain
          required:
            - txBytes
            - description
          properties:
            txBytes:
              type: string
              description: Base64 encoded transaction bytes
            description:
              type: string
              example: "Attest KPI: Revenue = $11,300,000 (Approved)"
            estimatedGas:
              type: integer
              example: 1800000

    GetKPIStatusResponse:
      type: object
      required:
        - periodId
        - periodName
      properties:
        periodId:
          type: string
          description: Period identifier
          example: "period_2026"
        periodName:
          type: string
          description: Period name
          example: "2026 Fiscal Year"
        proposal:
          $ref: '#/components/schemas/KPIProposal'
        attestation:
          $ref: '#/components/schemas/KPIAttestation'
        status:
          type: string
          enum: ["not_proposed", "proposed", "attested", "rejected"]
          description: Overall KPI status
          example: "attested"
        nextAction:
          type: string
          description: Suggested next action
          example: "Ready for settlement"
        relatedBlobs:
          type: array
          description: Related Walrus blobs for this period
          items:
            $ref: './walrus.yaml#/components/schemas/WalrusBlobReference'
