paths:
  /walrus/upload:
    post:
      summary: Upload encrypted file to Walrus (Upload Relay)
      description: |
        **Purpose**: Upload encrypted financial documents to Walrus decentralized storage

        **Why Upload Relay is Needed**:
        - Direct browser uploads to Walrus require ~2000+ HTTP requests per file
        - This creates significant browser performance issues and potential failures
        - Upload relay reduces this to a single API call from frontend
        - Backend handles the heavy lifting using @mysten/walrus SDK

        **Upload Flow**:
        1. **Frontend**: User selects file (e.g., revenue_q1_2026.csv)
        2. **Frontend**: Encrypts file using @mysten/seal SDK â†’ produces ciphertext
        3. **Frontend**: Sends ciphertext to this endpoint via multipart/form-data
        4. **Backend**: Receives encrypted file
        5. **Backend**: Uses Walrus SDK to upload ciphertext to Walrus network
        6. **Walrus**: Returns blobId and commitment
        7. **Backend**: Returns blob metadata to frontend
        8. **Frontend**: Signs Sui transaction to register blob on-chain

        **Walrus Integration**:
        - SDK: Uses @mysten/walrus TypeScript SDK
        - Network: Uploads to configured Walrus aggregator/publisher
        - Storage: Stores ONLY encrypted ciphertext (never plaintext)
        - Metadata: Returns blobId and commitment for on-chain registration

        **Seal Integration**:
        - Encryption: File is already encrypted by frontend using Seal SDK
        - Policy: earnout_seal_policy controls who can decrypt
        - Access: Only buyer/seller/auditor can later decrypt this blob

        **Next Steps After Upload**:
        - Frontend must call a Sui transaction to register this blobId on-chain
        - Transaction binds blob to specific deal/period
        - This creates immutable audit trail of data submissions

        **Access Control**:
        - Role: Authenticated users (primarily buyer uploading data)
        - Verification: User must be a participant in the specified deal
      operationId: uploadToWalrus
      tags:
        - Walrus
      parameters:
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui wallet address of uploader
        - name: X-Sui-Signature
          in: header
          required: true
          schema:
            type: string
          description: Signature proving ownership
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - dealId
                - periodId
                - dataType
              properties:
                file:
                  type: string
                  format: binary
                  description: |
                    Encrypted file (ciphertext)
                    IMPORTANT: This must be encrypted using Seal SDK before upload
                dealId:
                  type: string
                  pattern: '^0x[a-fA-F0-9]{64}$'
                  description: Deal ID this file belongs to
                  example: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                periodId:
                  type: string
                  description: Period ID this file belongs to
                  example: "period_2026"
                dataType:
                  type: string
                  enum: [
                    "revenue_journal",
                    "ebitda_report",
                    "expense_report",
                    "balance_sheet",
                    "cash_flow",
                    "kpi_calculation",
                    "audit_report",
                    "custom"
                  ]
                  description: Type of financial data
                  example: "revenue_journal"
                customDataType:
                  type: string
                  description: Custom data type name (if dataType is 'custom')
                  example: "Customer Acquisition Cost Report"
                filename:
                  type: string
                  description: Original filename
                  example: "revenue_q1_2026.csv"
                description:
                  type: string
                  maxLength: 500
                  description: File description
                  example: "Q1 2026 revenue journal with detailed transaction logs"
            example:
              file: "[Binary encrypted data]"
              dealId: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
              periodId: "period_2026"
              dataType: "revenue_journal"
              filename: "revenue_q1_2026.csv"
              description: "Q1 2026 revenue journal"
      responses:
        '200':
          description: File successfully uploaded to Walrus
          content:
            application/json:
              schema:
                $ref: '../schemas/walrus.yaml#/components/schemas/WalrusUploadResponse'
              example:
                blobId: "blob_2Nf8pQz3Xm7Yk5Rd9Wv1Bc6Lt4Hs"
                commitment: "sha256:a1b2c3d4e5f67890abcdef1234567890abcdef1234567890abcdef12345678"
                size: 2048576
                uploadedAt: "2026-03-15T09:30:00Z"
                blobReference:
                  blobId: "blob_2Nf8pQz3Xm7Yk5Rd9Wv1Bc6Lt4Hs"
                  dataType: "revenue_journal"
                  uploadedAt: "2026-03-15T09:30:00Z"
                  uploaderAddress: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                  size: 2048576
                  metadata:
                    filename: "revenue_q1_2026.csv"
                    mimeType: "text/csv"
                    description: "Q1 2026 revenue journal"
                    periodId: "period_2026"
                    encrypted: true
                nextStep:
                  action: "register_on_chain"
                  description: "Sign transaction to register this blob on-chain"
                  transaction:
                    txBytes: "AAACAAgA..."
                    description: "Register Walrus blob: revenue_journal for period_2026"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ValidationError'
              examples:
                missingFile:
                  value:
                    error: "ValidationError"
                    message: "File is required"
                    statusCode: 400
                fileTooLarge:
                  value:
                    error: "ValidationError"
                    message: "File size exceeds maximum allowed (100MB)"
                    statusCode: 400
                    details:
                      maxSize: 104857600
                      actualSize: 150000000
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '403':
          description: Forbidden - User not authorized for this deal
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ForbiddenError'
        '404':
          description: Deal or period not found
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/NotFoundError'
        '500':
          description: Walrus upload failed
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ErrorResponse'
              example:
                error: "WalrusUploadError"
                message: "Failed to upload file to Walrus network"
                statusCode: 500
                details:
                  reason: "Connection timeout to Walrus aggregator"
